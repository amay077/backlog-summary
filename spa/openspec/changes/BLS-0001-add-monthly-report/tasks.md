# Implementation Tasks

## プロジェクト設定

- [ ] 依存パッケージのインストール（csv-writer, commander, dotenv, @types/node）
- [ ] TypeScript 設定の更新（scripts/ ディレクトリをビルド対象に追加）
- [ ] package.json の scripts セクションに `generate-report` コマンドを追加
- [ ] .gitignore に `reports/` ディレクトリと `.env` ファイルを追加
- [ ] `.env.example` ファイルの作成（環境変数のテンプレート）

## スクリプト実装

- [ ] `scripts/generate-monthly-report.ts` ファイルの作成
- [ ] 環境変数読み込みの実装（dotenv 使用）
  - `BACKLOG_SPACE_ID`: Backlog スペース ID（例：nepula）
  - `BACKLOG_API_KEY`: Backlog API キー
  - ドメインの構築（`https://${BACKLOG_SPACE_ID}.backlog.com`）
  - 環境変数の検証とエラーハンドリング
- [ ] コマンドライン引数パーサーの実装（commander 使用）
  - `--month <YYYY-MM>`: 対象月（必須）
- [ ] Backlog API クライアントの実装
  - ユーザー認証（`/api/v2/users/myself`）
  - アクティビティ取得（`/api/v2/users/{userId}/activities`）
- [ ] ページネーション処理の実装
  - `maxId` パラメータを使用した全件取得
  - 指定月の範囲内のアクティビティのみフィルタリング
- [ ] アクティビティタイプ処理の実装
  - Type 1: 課題追加
  - Type 2: 課題更新
  - Type 3: 課題コメント
  - Type 5: Wiki 追加
  - Type 6: Wiki 更新
  - Type 12: Git push
  - Type 13: Git リポジトリ作成
  - Type 14: 課題一括更新（個別コメントに分解）
- [ ] データ変換処理の実装
  - Backlog API レスポンスから必要な情報を抽出
  - 明細CSV用のデータ構造に変換
  - サマリ集計用のデータ構造に変換
- [ ] 明細 CSV 出力処理の実装
  - ヘッダー行：日時, プロジェクトキー, プロジェクト名, アクティビティ種類, タイトル/概要
  - データ行：各アクティビティの情報（日時は YYYY/MM/DD HH:mm:ss JST 形式）
  - 出力先：`reports/{YYYY-MM}-report-detail.csv`
- [ ] 業務日グルーピング処理の実装
  - AM6:00〜翌日の AM5:59:59 を1業務日として扱う
  - 日時から業務日を計算する関数を実装
  - AM6:00 前のアクティビティは前日の業務日として扱う
- [ ] サマリ集計処理の実装
  - 業務日とプロジェクトキーでアクティビティをグルーピング
  - 各業務日の全プロジェクトでの開始時刻（最小日時の HH:mm）と終了時刻（最大日時の HH:mm）を計算
  - 各グループ（業務日×プロジェクト）の件数、最小日時、最大日時を計算
  - プロジェクトキーをアルファベット順にソート
- [ ] サマリ CSV 出力処理の実装
  - ヘッダー行：日付, 開始時刻, 終了時刻, {プロジェクトキー}_件数, {プロジェクトキー}_最小日時, {プロジェクトキー}_最大日時, ...
  - データ行：各業務日の開始時刻、終了時刻、プロジェクト別統計情報
  - アクティビティがないプロジェクトは件数0、日時は空文字列
  - 出力先：`reports/{YYYY-MM}-report-summary.csv`
- [ ] エラーハンドリングの実装
  - 環境変数エラー（BACKLOG_SPACE_ID または BACKLOG_API_KEY が未設定）
  - API エラー（認証失敗、ネットワークエラー）
  - 不正な引数（月フォーマット、必須パラメータ不足）
  - ファイル書き込みエラー

## テストと検証

- [ ] TypeScript ビルドの確認（`npm run build` または `tsc`）
- [ ] サンプルデータでの動作確認
  - 各アクティビティタイプが正しく処理されるか
  - 明細 CSV 出力フォーマットが正しいか
  - Type 14 の分解処理が正しく動作するか
  - 業務日グルーピング（AM6:00 基準）が正しく動作するか
  - サマリ CSV のヘッダーとデータ行が正しいか
  - 開始時刻と終了時刻が正しく計算されているか（全プロジェクトの最小・最大）
  - プロジェクトキーがアルファベット順にソートされているか
  - アクティビティがないプロジェクトが正しく処理されるか（件数0、日時空）
- [ ] エラーケースのテスト
  - 環境変数未設定（BACKLOG_SPACE_ID または BACKLOG_API_KEY）
  - 無効な API キー
  - 存在しない月
  - ネットワークエラー

## ドキュメント更新

- [ ] README.md に「月次報告書の生成」セクションを追加
  - .env ファイルの設定方法
  - 使用方法
  - コマンドライン引数の説明（--month のみ）
  - 出力ファイルの説明
    - 明細 CSV（`reports/{YYYY-MM}-report-detail.csv`）のフォーマットとヘッダー
    - サマリ CSV（`reports/{YYYY-MM}-report-summary.csv`）のフォーマットとヘッダー
    - 業務日の定義（AM6:00 基準）
  - 使用例
- [ ] package.json の scripts セクションにコメント追加（必要に応じて）
