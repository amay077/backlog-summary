# 月次報告書生成機能の追加

## Why

毎月、Backlog での活動内容を会社に報告する必要があるが、現状では手動でアクティビティを確認・集計しており、以下の課題がある：

- **時間がかかる**：月末に1ヶ月分のアクティビティを手動で確認・記録するのは非効率
- **記録漏れのリスク**：手動作業のため、アクティビティの見落としや記録漏れが発生する可能性がある
- **フォーマットの不統一**：毎回手作業で作成するため、報告書のフォーマットが不統一になりがち

自動化により、正確で効率的な月次報告書の作成が可能になる。

## What Changes

Backlog のアクティビティを月単位で集計し、CSV 形式で出力する Node.js スクリプトを追加する。

**主な機能：**
- 指定した月（YYYY-MM 形式）の全アクティビティを Backlog API から取得
- アクティビティタイプ（課題追加、課題更新、コメント、Wiki、Git push など）をすべてサポート
- Type 14（課題一括更新）を個別のコメントアクティビティに分解
- **2種類の CSV ファイルを出力**：

  **1. 明細 CSV** (`reports/{YYYY-MM}-report-detail.csv`)
  - 全アクティビティの詳細情報を1行ずつ出力
  - カラム：
    - 日時（YYYY/MM/DD HH:mm:ss JST）
    - プロジェクトキー（例：SDBT）
    - プロジェクト名（例：(社内)すいどーばた）
    - アクティビティ種類（課題追加、課題更新、コメント、Wiki 追加/更新、Git push など）
    - タイトル/概要（課題タイトル、Wiki 名、コミットメッセージなど）

  **2. 月日別サマリ CSV** (`reports/{YYYY-MM}-report-summary.csv`)
  - 日付とプロジェクトキーごとにアクティビティを集計
  - 日付の区切り：AM6:00〜翌日の AM5:59:59（業務日基準）
  - **指定月の全日付を出力**（アクティビティがない日も含む）
  - カラム構成：
    - 行キー：日付（YYYY-MM-DD）
    - 共通列：
      - `開始時刻`：原則 `9:00` で固定。ただし稼働がない日は空欄。最小日時が 13:00 以降の場合は `13:00`（午前半休と推測）
      - `終了時刻`：その業務日のすべてのアクティビティの最大日時を30分刻みで丸め、15:00以降の場合は1時間減算（0-14分 → :00, 15-44分 → :30, 45-59分 → 次の時間の :00）
        - **1時間減算**：丸めた後の終了時刻が15:00以降の場合、1時間減算して家事休憩を再現（例：18:00 → 17:00）
        - **深夜残業対応**：23:59以降（翌日6時前）の場合は24時間超表記を使用（例：午前2:00 → 26:00）
      - `稼動時間`：勤務開始〜勤務終了の労働時間から休憩時間を引いた値（小数、例：8.5）
        - **勤務開始時刻**：朝休憩コードに応じた固定値、または開始時刻を15分単位で切り上げ
          - 朝休憩コード=5 → 8:00、朝休憩コード=1 → 12:45、それ以外 → 開始時刻を15分単位切り上げ
        - **勤務終了時刻**：深夜休憩コードに応じた固定値、または終了時刻を15分単位で切り捨て
          - 深夜休憩コード=5 → 28:00、3 → 26:00、1 → 24:00、午後休憩コード=3 → 22:00、1 → 19:30、それ以外 → 終了時刻を15分単位切り捨て
        - **労働時間** = 勤務終了時刻 - 勤務開始時刻
        - **休憩時間** = INT((朝休憩コード + 午後休憩コード + 深夜休憩コード) / 2) × 0.5 時間
        - **朝休憩コード**：勤務開始時刻に基づく（< 7:00 → 8、< 8:00 → 5、< 11:45 → 4、< 12:45 → 1、それ以外 → 0）
        - **午後休憩コード**：勤務終了時刻に基づく（> 22:44 → 4、> 22:00 → 3、> 20:14 → 2、> 19:30 → 1、それ以外 → 0）
        - **深夜休憩コード**：勤務終了時刻に基づく（> 28:44 → 6、> 28:00 → 5、> 26:44 → 4、> 26:00 → 3、> 24:44 → 2、> 24:00 → 1、それ以外 → 0）
        - **稼動時間** = 労働時間 - 休憩時間
    - プロジェクト別稼動時間列：プロジェクトキーごとに1列
      - `{プロジェクトキー}`：そのプロジェクトに配分された稼動時間
      - **配分方法**：
        1. 稼動時間を各プロジェクトの件数で按分する
        2. 0.5刻みになるように値を丸める（例: 4.24→4.0、4.25→4.5）
           - ただし、0.5未満は一律で 0.5 として（最小単位が 0.5）
        3. 合計値が稼動時間と一致するように値を調整する
           - 合計値＞稼動時間の場合：稼動の多いプロジェクト順に 0.5 減算し、一致するまで繰り返す
           - 合計値＜稼動時間の場合：稼動の少ないプロジェクト順に 0.5 加算し、一致するまで繰り返す
    - プロジェクト別統計列：プロジェクトキーごとに3列
      - `{プロジェクトキー}_件数`：そのプロジェクトのアクティビティ件数
      - `{プロジェクトキー}_最小日時`：最初のアクティビティの日時
      - `{プロジェクトキー}_最大日時`：最後のアクティビティの日時
  - 例：`日付,開始時刻,終了時刻,稼動時間,BLS,SDBT,...,BLS_件数,BLS_最小日時,BLS_最大日時,SDBT_件数,SDBT_最小日時,SDBT_最大日時,...`

**技術スタック：**
- TypeScript（既存コードと統一）
- Backlog API v2（既存の SPA と同じ API を使用）
- csv-writer（CSV 出力）
- commander（コマンドライン引数パース）
- dayjs（日付操作、既存依存関係を活用）

**使用方法：**

1. `.env` ファイルに Backlog 認証情報を設定：
```bash
BACKLOG_SPACE_ID=nepula
BACKLOG_API_KEY=your-api-key
```

2. スクリプトを実行：
```bash
# Shift-JIS（デフォルト）
npm run generate-report -- --month 2025-10

# UTF-8
npm run generate-report -- --month 2025-10 --encoding utf-8
```

または環境変数で直接指定：
```bash
BACKLOG_SPACE_ID=nepula BACKLOG_API_KEY=YOUR_API_KEY npm run generate-report -- --month 2025-10
```

**注意**:
- スクリプトは `BACKLOG_SPACE_ID` から `https://${BACKLOG_SPACE_ID}.backlog.com` というドメインを自動構築します。
- CSV ファイルのエンコーディングはデフォルトで `shift-jis` です。`--encoding utf-8` で UTF-8 に変更できます。

## Impact

**Affected specs:**
- 新規機能のため、既存の仕様への影響はなし

**Affected code:**
- `package.json`：新しい dependencies と scripts の追加
- `scripts/` ディレクトリ：新規スクリプトファイルの追加
- `reports/` ディレクトリ：出力先ディレクトリ（新規作成、.gitignore に追加）
- `README.md`：使用方法セクションの追加

**Breaking changes:**
- なし（既存機能に影響を与えない新規追加）

**Dependencies:**
以下のパッケージを追加：
- `csv-writer`: CSV ファイル生成
- `commander`: CLI 引数パース
- `dotenv`: .env ファイルからの環境変数読み込み
- `iconv-lite`: エンコーディング変換（UTF-8 ⇔ Shift-JIS）
- `@types/node`: Node.js 型定義（開発用）
- （既存）`dayjs`: 日付操作（既に導入済み）
- （既存）`node-fetch` または組み込みの `fetch`: HTTP クライアント

**開発・テスト環境への影響：**
- TypeScript のビルド設定に `scripts/` ディレクトリを追加
- npm scripts に `generate-report` コマンドを追加
